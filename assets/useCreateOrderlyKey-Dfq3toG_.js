import{W as j,r}from"./index-gtzDq4NN.js";import{w as I,I as $,u as D,a as L,s as T,m as O,g as C,U as S,b as K,r as P,c as A}from"./usePrivateQuery-C4ovqd4J.js";import{aW as F,u as N}from"./ModalContext-mlJE0UaS.js";import{u as k}from"./OrderlyKeyContext-4mPVxEwy.js";import{y as v}from"./globalDisconnect-BwfQ2Vw-.js";const b=$?t=>{t()}:j.startTransition,x=t=>{const[,e]=r.useState({}),s=r.useRef(!1),i=r.useRef(t),l=r.useRef({data:!1,error:!1,isValidating:!1}),g=r.useCallback(n=>{let o=!1;const u=i.current;for(const y in n)if(Object.prototype.hasOwnProperty.call(n,y)){const c=y;u[c]!==n[c]&&(u[c]=n[c],l.current[c]&&(o=!0))}o&&!s.current&&e({})},[]);return K(()=>(s.current=!1,()=>{s.current=!0})),[i,l.current,g]},z=()=>(t,e,s={})=>{const{mutate:i}=L(),l=r.useRef(t),g=r.useRef(e),n=r.useRef(s),o=r.useRef(0),[u,y,c]=x({data:S,error:S,isMutating:!1}),m=u.current,w=r.useCallback(async(E,R)=>{const[d,M]=T(l.current);if(!g.current)throw new Error("Can’t trigger the mutation: missing fetcher.");if(!d)throw new Error("Can’t trigger the mutation: missing key.");const a=O(O({populateCache:!1,throwOnError:!0},n.current),R),h=C();o.current=h,c({isMutating:!0});try{const f=await i(d,g.current(M,{arg:E}),O(a,{throwOnError:!0}));return o.current<=h&&(b(()=>c({data:f,isMutating:!1,error:void 0})),a.onSuccess==null||a.onSuccess.call(a,f,d,a)),f}catch(f){if(o.current<=h&&(b(()=>c({error:f,isMutating:!1})),a.onError==null||a.onError.call(a,f,d,a),a.throwOnError))throw f}},[]),p=r.useCallback(()=>{o.current=C(),c({data:S,error:S,isMutating:!1})},[]);return K(()=>{l.current=t,g.current=e,n.current=s}),{trigger:w,reset:p,get data(){return y.data=!0,m.data},get error(){return y.error=!0,m.error},get isMutating(){return y.isMutating=!0,m.isMutating}}},B=I(D,z),_=(t,e)=>{const s={method:e.arg.method,headers:{...e.arg.signature}};if(e.arg.data&&(s.body=JSON.stringify(e.arg.data)),typeof e.arg.params=="object"&&Object.keys(e.arg.params).length){const i=new URLSearchParams(e.arg.params);t=`${t}?${i.toString()}`}return P(t,s)},Q=(t,e="POST",s)=>{const i=F(),{accountId:l,orderlyKey:g}=k(),n=r.useRef(t),o=r.useRef(e);r.useEffect(()=>{n.current=t,o.current=e},[t,e]);let u=t;t.startsWith("http")||(u=`${i}${t}`);const{trigger:y,data:c,error:m,reset:w,isMutating:p}=B(()=>u,_,s);return[async(R,d,M)=>{const a=n.current,h=o.current;let f=a;if(typeof d=="object"&&Object.keys(d).length){const W=new URLSearchParams(d);f=`${a}?${W.toString()}`}const U=await A({accountId:l,orderlyKey:g,payload:{method:h,url:f,data:R}});return y({data:R,params:d,method:h,signature:U},M)},{data:c,error:m,reset:w,isMutating:p}]};function X(){const[t,e]=r.useState(!1),{openModal:s}=N(),{setOrderlyKey:i,...l}=k();return{isCreatingKey:t,createOrderlyKey:async({brokerId:n,accountId:o})=>{e(!0);try{s("orderlyKeyLogin",{onSuccess:u=>{i(u)},onCancel:()=>{e(!1)},brokerId:n,accountId:o})}catch(u){console.error("Failed to create orderly key:",u),v.error("Failed to create orderly key")}finally{e(!1)}},...l}}export{X as a,Q as u};
